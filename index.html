<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="apple-touch-icon" href="/images/icon.png">

  <title>Petshop Checklist</title>

  <style>
    :root {
      --bg: #f5f5f5;
      --text: #111;
      --card-bg: #fff;
      --card-border: #ccc;
      --accent: #4caf50;
      --filter-bg: #fff;
      --modal-bg: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] {
      --bg: #1e1e1e;
      --text: #eee;
      --card-bg: #2c2c2c;
      --card-border: #444;
      --accent: #81c784;
      --filter-bg: #2a2a2a;
      --modal-bg: rgba(0, 0, 0, 0.7);
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: var(--filter-bg);
      border-bottom: 1px solid var(--card-border);
      flex-shrink: 0;
      gap: 1rem;
      flex-wrap: nowrap;
    }
    #auth-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;

      /* Take full viewport height for vertical centering */
      height: 100vh;
      max-width: 300px; /* limit width for nicer input size */
      margin: 0 auto; /* center horizontally */
      padding: 20px;
      border-radius: 8px;
      box-sizing: border-box;
    }

    /* Inputs and buttons stacked vertically */
    #auth-section input,
    #auth-section button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    #auth-section button {
      background-color: #838282;
      color: white;
      cursor: pointer;
      border: none;
    }

    #auth-section button:hover {
      background-color: #757575;
    }

    #auth-status {
      margin-top: 10px;
      color: #d9534f; /* red for error/status */
      min-height: 1.2em; /* keep space even when empty */
      text-align: center;
      font-weight: 600;
    }
    /* Logo */
    #sidebar-logo {
      max-height: 40px;
      object-fit: contain;
      flex-shrink: 0;
      margin-right: 0.75rem;
    }

    #header-content {
      display: none;
    }
    /* Container for filters + search aligned LEFT just after logo */
    .filters-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 1;
      min-width: 0;
      max-width: 460px;
      justify-content: flex-start;
    }

    /* Search dropdown container */
    .search-container {
      position: relative;
      flex: 1 1 auto;
      max-width: 160px;
      min-width: 0;
    }

    #search-dropdown {
      width: 100%;
      padding: 0.4rem 0.6rem;
      font-size: 1rem;
      border: 1px solid var(--card-border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      min-width: 0;
    }

    /* Shorter dropdowns */
    select.filter-select {
      padding: 0.4rem 0.6rem;
      font-size: 1rem;
      border: 1px solid var(--card-border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      flex-shrink: 0;
      min-width: 100px;
      max-width: 120px;
    }

    /* Progress container on right */
    .progress-container {
      display: none;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
      min-width: 110px;
      white-space: nowrap;
      justify-content: flex-end;
    }

    .progress-text {
      font-size: 0.9rem;
      white-space: nowrap;
      min-width: 50px;
      text-align: right;
    }

    .progress-bar {
      background: #8884;
      border-radius: 5px;
      overflow: hidden;
      height: 16px;
      width: 90px;
      min-width: 90px;
    }

    .progress-bar-inner {
      background: var(--accent);
      height: 100%;
      transition: width 0.3s ease-in-out;
    }

    /* Mobile filter button */
    .mobile-filter-btn {
      display: none;
      padding: 0.4rem 0.8rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      align-items: center;
      gap: 0.3rem;
    }

    .mobile-filter-btn:hover {
      background: #45a049;
    }

    /* Filter modal */
    .filter-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--modal-bg);
      z-index: 1000;
      align-items: flex-start;
      justify-content: center;
      padding-top: 20px;
    }

    .filter-modal.active {
      display: flex;
    }

    .filter-modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .filter-modal h3 {
      margin: 0 0 1rem 0;
      text-align: center;
    }

    .filter-group {
      margin-bottom: 1rem;
    }

    .filter-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--card-border);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text);
      font-size: 1rem;
      box-sizing: border-box;
    }

    .filter-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .filter-actions button {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }

    .apply-btn {
      background: var(--accent);
      color: white;
    }

    .cancel-btn {
      background: var(--card-border);
      color: var(--text);
    }

    main {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    /* Empty state message */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text);
      opacity: 0.7;
    }

    .empty-state h3 {
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }

    .empty-state p {
      margin: 0;
      font-size: 0.9rem;
    }

    /* Grid for desktop */
    .pet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    /* Base pet card style */
.pet-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.5rem;
  border-radius: 8px;
  background: var(--card-bg, #fff);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  overflow: hidden;
  max-width: 100%;
}

/* Image styling */
.pet-card img {
  width: 100%;
  height: auto;
  max-height: 140px;
  object-fit: contain;
  margin-bottom: 0.5rem;
}

/* Label wrapping the checkbox and text */
.pet-card label {
  display: flex;
  flex-direction: row;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
  width: 100%;
  justify-content: center;
  text-align: center;
}

/* Text inside card */
.pet-card label span {
  font-size: 0.85rem;
  line-height: 1.2;
  word-break: break-word;
}

/* Responsive for smaller devices */
@media (max-width: 600px) {
  .pet-card label {
    flex-direction: column;
  }

  .pet-card img {
    max-height: 120px;
  }
}


    /* Prettier dark mode toggle */
    #darkModeToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #darkModeToggle:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    #darkModeToggle:active {
      transform: translateY(0);
    }

    /* MOBILE */
    @media (max-width: 768px) {
      header {
        padding: 0.5rem 0.75rem;
      }

      /* Hide desktop filters on mobile */
      .filters-left {
        display: none;
      }

      /* Show mobile filter button */
      .mobile-filter-btn {
        display: flex;
      }

      .progress-container {
        min-width: 90px;
      }

      .progress-bar {
        width: 70px;
        min-width: 70px;
        height: 14px;
      }

      .progress-text {
        font-size: 0.85rem;
        min-width: 40px;
      }

      /* Pet card layout mobile: image left, info right */
      /*.pet-grid {
        display: block;
      }

      .pet-card {
        flex-direction: row;
        align-items: center;
        text-align: left;
        padding: 0.5rem 0.75rem;
      }

      .pet-card img {
        margin-bottom: 0;
        margin-right: 0.75rem;
        max-width: 70px;
        max-height: 70px;
        flex-shrink: 0;
      }

      .pet-card label {
        flex-direction: row;
        align-items: center;
        gap: 0.6rem;
        font-size: 1rem;
      }

      .pet-card label span {
        display: inline-block;
      }*/

      #darkModeToggle {
        bottom: 15px;
        right: 15px;
        width: 48px;
        height: 48px;
        font-size: 18px;
      }
    }

    /* Show desktop filters on larger screens */
    @media (min-width: 769px) {
      .filters-left {
        display: flex;
      }

      .mobile-filter-btn {
        display: none;
      }
    }
  </style>
</head>
<body>

  <header>
    <img id="sidebar-logo" src="images/lps-logo.png" alt="LPS Logo" />
    
    <div id="header-content">
      <!-- Desktop filters -->
      <div class="filters-left">
        <div class="search-container">
          <select id="search-dropdown" aria-label="Search pets">
            <option value="">All pets...</option>
          </select>
        </div>
        <select id="gen-select" class="filter-select" aria-label="Select generation">
          <option value="">All generations</option>
        </select>
        <select id="check-filter" class="filter-select" aria-label="Filter checked items">
          <option value="all">All</option>
          <option value="checked">Checked</option>
          <option value="unchecked">Unchecked</option>
        </select>
      </div>

      <!-- Mobile filter button -->
      <button class="mobile-filter-btn" id="mobile-filter-btn">

        <span>Filters</span>
      </button>
    </div>
    
    <div class="progress-container" id="progress-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Checked progress">
      <div class="progress-text" id="progress-text">0 / 0</div>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-bar-inner" id="progress-bar-inner" style="width: 0%;"></div>
      </div>
    </div>
    
  </header>

  <!-- Mobile filter modal -->
  <div class="filter-modal" id="filter-modal">
    <div class="filter-modal-content">
      <h3>Filters</h3>
      
      <div class="filter-group">
        <label for="modal-search">Search pets:</label>
        <select id="modal-search">
          <option value="">All pets...</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="modal-generation">Generation:</label>
        <select id="modal-generation">
          <option value="">All generations</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="modal-checked">Status:</label>
        <select id="modal-checked">
          <option value="all">All</option>
          <option value="checked">Checked</option>
          <option value="unchecked">Unchecked</option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="cancel-btn" id="cancel-filters">Cancel</button>
        <button class="apply-btn" id="apply-filters">Apply</button>
      </div>
    </div>
  </div>

  <!-- Add this somewhere in your <body> -->
  <div id="auth-section" display: hidden>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="signin-btn">Sign In</button>
      <button id="signup-btn">Sign Up</button>
      <p id="auth-status"></p>
  </div>

  <div id="checklist-section" style="display: none;">
      <h2>Your Checklist</h2>
      <input type="text" id="checklist-item-input" placeholder="New item...">
      <button id="add-item-btn">Add Item</button>
      <ul id="checklist-items">
          <!-- Checklist items will appear here -->
      </ul>
  </div>

  <main>
    <div class="pet-grid" id="pet-grid"></div>
  </main>

  <button id="darkModeToggle" title="Toggle theme">🌙</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js';
    import { signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js';
    import { createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js';
    import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC7qrHuULs_dzP-WlN62G3nMVcqegQMnZo",
      authDomain: "lps-checklist.firebaseapp.com",
      projectId: "lps-checklist",
      storageBucket: "lps-checklist.firebasestorage.app",
      messagingSenderId: "1003458248363",
      appId: "1:1003458248363:web:c58fcb6d6912d112d401ee"
    };

    // 3. Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // 4. Export or make available the services you need
    const auth = getAuth(app);
    const db = getFirestore(app);
  
    let allPetshops = [];
    let activeGen = '';
    let searchTerm = '';
    let checkFilter = 'all';
    let checklistState = {};


    const grid = document.getElementById("pet-grid");
    const genSelect = document.getElementById("gen-select");
    const searchDropdown = document.getElementById("search-dropdown");
    const checkFilterSelect = document.getElementById("check-filter");
    const progressText = document.getElementById("progress-text");
    const progressBar = document.getElementById("progress-bar-inner");
    const darkToggle = document.getElementById("darkModeToggle");
    
    // Mobile elements
    const mobileFilterBtn = document.getElementById("mobile-filter-btn");
    const filterModal = document.getElementById("filter-modal");
    const modalSearch = document.getElementById("modal-search");
    const modalGeneration = document.getElementById("modal-generation");
    const modalChecked = document.getElementById("modal-checked");
    const applyFiltersBtn = document.getElementById("apply-filters");
    const cancelFiltersBtn = document.getElementById("cancel-filters");

    const storageKey = "petshopChecklist";
    const themeKey = "petshopTheme";

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signup-btn');
    const signinBtn = document.getElementById('signin-btn');
    const signoutBtn = document.getElementById('signout-btn');
    const authStatus = document.getElementById('auth-status');
    const authSection = document.getElementById('auth-section');
    const checklistSection = document.getElementById('checklist-section');
    const checklistItemInput = document.getElementById('checklist-item-input');
    const addItemBtn = document.getElementById('add-item-btn');
    const checklistItemsUl = document.getElementById('checklist-items');

    let currentUser = null; // To store the currently logged-in user

    let loggedin = 0;
    checkAuth(loggedin);

    function checkAuth(login) {
      if (login ==1 ) {
        // Show header content (everything except the logo)
        document.getElementById('header-content').style.display = 'block';
        document.getElementById('progress-container').style.display = 'flex';
        document.getElementById('pet-grid').style.display = 'grid';
        document.getElementById('auth-section').style.display = 'none';
      } else {
        // Optional: hide the header content if login is false
        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('header-content').style.display = 'none';
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('pet-grid').style.display = 'none';
      }
    }
    
    async function loadUserState(userId) {
      const docRef = doc(db, "users", userId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        return docSnap.data().checklistState || {};
      } else {
        return {};
      }
    }

    async function saveUserState(userId, state) {
      const docRef = doc(db, "users", userId);
      await setDoc(docRef, { checklistState: state });
    }

    function updateProgress(checkedCount, totalCount) {
      progressText.textContent = `${checkedCount} / ${totalCount}`;
      const percent = totalCount ? Math.round((checkedCount / totalCount) * 100) : 0;
      progressBar.style.width = percent + "%";
      progressBar.parentElement.setAttribute('aria-valuenow', percent);
    }

    function createEmptyState() {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "empty-state";
      emptyDiv.innerHTML = `
        <h3>No pets found</h3>
        <p>Try adjusting your filters to see more results.</p>
      `;
      return emptyDiv;
    }

    function renderPets() {
      grid.innerHTML = "";
      const state = checklistState;

      let filteredPets = allPetshops;

      if (activeGen) {
        filteredPets = filteredPets.filter(p => p.generation === activeGen);
      }

      if (searchTerm) {
        filteredPets = filteredPets.filter(p => 
          p.name.toLowerCase() === searchTerm.toLowerCase()
        );
      }


      filteredPets = filteredPets.filter(p => {
        const isChecked = state[p.id] === true;
        if (checkFilter === "checked" && !isChecked) return false;
        if (checkFilter === "unchecked" && isChecked) return false;
        return true;
      });

      const progressPets = activeGen ? 
        allPetshops.filter(p => p.generation === activeGen) : 
        allPetshops;
        
      let checkedCount = progressPets.reduce((acc, pet) => acc + (state[pet.id] ? 1 : 0), 0);
      updateProgress(checkedCount, progressPets.length);

      if (filteredPets.length === 0) {
        grid.appendChild(createEmptyState());
        return;
      }

      filteredPets.forEach(pet => {
        const isChecked = state[pet.id] === true;

        const card = document.createElement("div");
        card.className = "pet-card";

        const img = document.createElement("img");
        img.src = "images/" + pet.image;
        img.alt = pet.name;

        const label = document.createElement("label");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = isChecked;
        checkbox.addEventListener("change", async () => {
          checklistState[pet.id] = checkbox.checked;
          if (currentUser) {
            await saveUserState(currentUser.uid, checklistState);
          }
          renderPets();
        });

        const idSpan = document.createElement("span");
        idSpan.textContent = pet.id.replace("LPS-", "#");
        idSpan.style.fontWeight = "bold";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = pet.name;

        label.appendChild(checkbox);
        label.appendChild(idSpan);
        label.appendChild(nameSpan);

        card.appendChild(img);
        card.appendChild(label);
        grid.appendChild(card);
      });
    }


    function populateSearchOptions() {
      // Get unique pet names sorted alphabetically
      const petNames = [...new Set(allPetshops.map(p => p.name))].sort();
      
      // Clear existing options except first
      searchDropdown.innerHTML = '<option value="">All pets...</option>';
      modalSearch.innerHTML = '<option value="">All pets...</option>';
      
      petNames.forEach(name => {
        const option1 = document.createElement("option");
        option1.value = name;
        option1.textContent = name;
        searchDropdown.appendChild(option1);
        
        const option2 = document.createElement("option");
        option2.value = name;
        option2.textContent = name;
        modalSearch.appendChild(option2);
      });
    }

    function renderFilters() {
      const generations = [...new Set(allPetshops.map(p => p.generation))].sort();
      
      // Clear existing options except first
      genSelect.innerHTML = '<option value="">All generations</option>';
      modalGeneration.innerHTML = '<option value="">All generations</option>';

      generations.forEach(gen => {
        const option1 = document.createElement("option");
        option1.value = gen;
        option1.textContent = gen;
        genSelect.appendChild(option1);
        
        const option2 = document.createElement("option");
        option2.value = gen;
        option2.textContent = gen;
        modalGeneration.appendChild(option2);
      });

      // Set current values
      genSelect.value = activeGen;
      modalGeneration.value = activeGen;
      searchDropdown.value = searchTerm;
      modalSearch.value = searchTerm;
      checkFilterSelect.value = checkFilter;
      modalChecked.value = checkFilter;
    }

    function loadTheme() {
      const theme = "light";
      document.documentElement.setAttribute("data-theme", theme);
      darkToggle.textContent = theme === "dark" ? "☀️" : "🌙";
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      loadTheme();
    }

    // Desktop filter events
    genSelect.addEventListener("change", e => {
      activeGen = e.target.value;
      renderPets();
    });

    searchDropdown.addEventListener("change", e => {
      searchTerm = e.target.value;
      renderPets();
    });

    checkFilterSelect.addEventListener("change", e => {
      checkFilter = e.target.value;
      renderPets();
    });

    // Mobile filter events
    mobileFilterBtn.addEventListener("click", () => {
      filterModal.classList.add("active");
      document.body.style.overflow = "hidden";
    });

    cancelFiltersBtn.addEventListener("click", () => {
      filterModal.classList.remove("active");
      document.body.style.overflow = "";
      // Reset modal values to current filters
      modalGeneration.value = activeGen;
      modalSearch.value = searchTerm;
      modalChecked.value = checkFilter;
    });

    applyFiltersBtn.addEventListener("click", () => {
      activeGen = modalGeneration.value;
      searchTerm = modalSearch.value;
      checkFilter = modalChecked.value;
      
      // Update desktop filters to match
      genSelect.value = activeGen;
      searchDropdown.value = searchTerm;
      checkFilterSelect.value = checkFilter;
      
      renderPets();
      filterModal.classList.remove("active");
      document.body.style.overflow = "";
    });

    // Close modal when clicking outside
    filterModal.addEventListener("click", (e) => {
      if (e.target === filterModal) {
        cancelFiltersBtn.click();
      }
    });

    darkToggle.addEventListener("click", toggleTheme);
    
    signinBtn.addEventListener('click', async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        currentUser = user;
        checklistState = await loadUserState(user.uid);
        loggedin = 1;
        checkAuth(loggedin);
        renderPets();
      } catch (error) {
        console.error('Sign-in error:', error.code, error.message);
        alert('Sign-in failed: ' + error.message);
      }
    });

    signupBtn.addEventListener('click', () => {
      const email = emailInput.value;
      const password = passwordInput.value;

      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          // Signed up successfully
          const user = userCredential.user;
          console.log('User signed up:', user);
          alert('Signup successful! You can now sign in.');
          // Optionally, automatically log in or redirect:
          // window.location.href = '/dashboard.html';
        })
        .catch(error => {
          console.error('Signup error:', error.code, error.message);
          alert('Signup failed: ' + error.message);
        });
    });

    async function init() {
      const res = await fetch("all_petshops.json");
      allPetshops = await res.json();
      loadTheme();
      populateSearchOptions();
      renderFilters();
      renderPets();
    }

    init();
  </script>

</body>
</html>